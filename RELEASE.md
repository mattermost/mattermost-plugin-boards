# Инструкция по созданию релиза

## Автоматическая сборка релиза

Проект настроен на автоматическую сборку и публикацию релизов при пуше в ветку `release`.

### Процесс создания релиза

1. **Обновите версию в `plugin.json`**
   ```bash
   # Отредактируйте файл plugin.json и измените поле "version"
   # Например: "version": "9.2.3"
   ```

2. **Закоммитьте изменения**
   ```bash
   git add plugin.json
   git commit -m "Bump version to 9.2.3"
   ```

3. **Запушьте в ветку release**
   ```bash
   git push origin main:release
   # или если вы уже в ветке release:
   git push origin release
   ```

4. **Автоматическая сборка и деплой**

   GitHub Actions автоматически:
   - Извлечет версию из `plugin.json`
   - Соберет плагин для Linux AMD64
   - Создаст git tag `v{version}` (например, `v9.2.3`)
   - Создаст GitHub Release
   - Загрузит файл `boards-{version}.tar.gz` в релиз
   - **Автоматически задеплоит плагин на ваш Mattermost сервер** (если настроены секреты)

### Что собирается

- **Платформа:** Linux AMD64 (оптимизировано для self-hosted)
- **Файл:** `boards-{version}.tar.gz`
- **Размер:** ~46 MB (только нужная платформа)
- **Содержимое:** Готовый плагин для установки в Mattermost
- **Совместимость:** Работает автоматическое обновление через Mattermost UI и API upload

**Почему только Linux AMD64?**
- Mattermost загружает только один бинарник, соответствующий OS/ARCH сервера
- Для self-hosted с одной архитектурой достаточно одной платформы
- Это стандартная практика и официально допустимо
- Уменьшает размер bundle в ~3.5 раза
- Ускоряет сборку и загрузку на сервер

### Установка на сервер

После создания релиза, скачайте и установите плагин:

```bash
# Скачайте релиз
wget https://github.com/fambear/mattermost-plugin-boards/releases/download/v9.2.3/boards-9.2.3.tar.gz

# Распакуйте в директорию плагинов Mattermost
cd /opt/mattermost/plugins
tar -xzf boards-9.2.3.tar.gz

# Перезапустите Mattermost
systemctl restart mattermost
```

Или используйте веб-интерфейс Mattermost:
1. System Console → Plugins → Plugin Management
2. Upload Plugin
3. Выберите скачанный файл `boards-{version}.tar.gz`
4. Enable плагин

### Автоматическое обновление через Mattermost UI

После настройки релизов, Mattermost может автоматически проверять обновления:

1. **Настройка в plugin.json:**
   - `release_notes_url` указывает на ваш репозиторий GitHub
   - Mattermost проверяет новые релизы по этому URL

2. **Проверка обновлений:**
   - System Console → Plugins → Plugin Management
   - Нажмите "Check for updates"
   - Если доступна новая версия, появится кнопка "Update"

3. **Автоматическая установка:**
   - Нажмите "Update"
   - Mattermost скачает новую версию
   - Плагин будет обновлен автоматически
   - Перезапуск Mattermost не требуется (hot reload)

**Примечание:** Mattermost автоматически выбирает нужный бинарник из архива в соответствии с OS/ARCH сервера. Для self-hosted достаточно одной платформы.

### Автоматический деплой на сервер

Workflow также поддерживает автоматический деплой плагина на ваш Mattermost сервер сразу после сборки.

#### Настройка секретов

Для автоматического деплоя необходимо настроить следующие секреты в GitHub:

1. Перейдите в **Settings → Secrets and variables → Actions**
2. Добавьте следующие секреты:

   - `MM_URL` - URL вашего Mattermost сервера (например: `https://mm.fambear.online`)
   - `MM_ACCESS_TOKEN` - Personal Access Token с правами `manage_system`
   - `MM_BOARD_PLUGIN_ID` - ID плагина (для Boards это `focalboard`)

#### Как получить Access Token

1. Войдите в Mattermost как системный администратор
2. Перейдите в **Profile → Security → Personal Access Tokens**
3. Нажмите **Create Token**
4. Введите описание (например: "GitHub Actions Deploy")
5. Скопируйте созданный токен и добавьте его в GitHub Secrets

#### Процесс автоматического деплоя

После успешной сборки релиза, workflow автоматически:

1. Скачивает собранный плагин из GitHub Release
2. Деактивирует текущую версию плагина на сервере
3. Загружает новую версию плагина
4. Активирует плагин

**Преимущества:**
- ✅ Полностью автоматический процесс
- ✅ Не требует ручного вмешательства
- ✅ Плагин обновляется сразу после сборки
- ✅ Нет простоя (hot reload)

**Примечание:** Если секреты не настроены, деплой будет пропущен, но релиз все равно будет создан.

### Обновление существующего релиза

Если релиз с текущей версией уже существует, workflow:
- Не создаст новый тег
- Обновит существующий релиз
- Заменит файл артефакта на новый

### Ручной запуск

Вы также можете запустить сборку вручную:
1. Перейдите в GitHub → Actions → Release Build
2. Нажмите "Run workflow"
3. Выберите ветку `release`
4. Нажмите "Run workflow"

### Проверка статуса сборки

Статус сборки можно посмотреть:
- GitHub → Actions → Release Build
- В Summary будет информация о созданном релизе

### Требования

Для работы workflow требуется:
- ✅ Версия в `plugin.json` должна быть корректной (формат: `X.Y.Z`)
- ✅ GitHub Actions должны иметь права на создание релизов (permissions: contents: write)
- ✅ Все зависимости должны быть доступны (npm packages, go modules)

### Troubleshooting

**Проблема:** Релиз не создается
- Проверьте логи GitHub Actions
- Убедитесь что версия в `plugin.json` корректна
- Проверьте что у вас есть права на push в ветку `release`

**Проблема:** Сборка падает
- Проверьте что все зависимости установлены
- Убедитесь что код компилируется локально: `make dist-linux`

**Проблема:** Тег уже существует
- Workflow обновит существующий релиз вместо создания нового
- Если нужно пересоздать тег, удалите его вручную:
  ```bash
  git tag -d v9.2.3
  git push origin :refs/tags/v9.2.3
  ```

